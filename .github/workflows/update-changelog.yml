name: Update Changelog

on:
  schedule:
    - cron: "0 23 * * 0" # Weekly on Sunday at 11pm UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch recent commits
        id: fetch-commits
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Calculate date for one week ago
          ONE_WEEK_AGO=$(date -d '7 days ago' +%Y-%m-%d)

          # Fetch commits from dotnet org authored by captainsafia
          COMMITS_DOTNET=$(gh api "/search/commits?q=author:captainsafia+org:dotnet+committer-date:>${ONE_WEEK_AGO}&sort=committer-date&order=desc&per_page=100" \
            --jq '[.items[] | {date: .commit.committer.date[0:10], repo: .repository.full_name, message: .commit.message | split("\n")[0], url: .html_url}]')

          # Fetch commits from all captainsafia org/user repos
          COMMITS_ORG=$(gh api "/search/commits?q=author:captainsafia+user:captainsafia+committer-date:>${ONE_WEEK_AGO}&sort=committer-date&order=desc&per_page=100" \
            --jq '[.items[] | {date: .commit.committer.date[0:10], repo: .repository.full_name, message: .commit.message | split("\n")[0], url: .html_url}]' 2>/dev/null || echo '[]')

          # Merge and dedupe commits
          ALL_COMMITS=$(echo "$COMMITS_DOTNET $COMMITS_ORG" | jq -s 'add | unique_by(.url)')

          # Save to file for the next step
          echo "$ALL_COMMITS" > /tmp/commits.json

          # Check if we have any commits
          COMMIT_COUNT=$(echo "$ALL_COMMITS" | jq 'length')
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          if [ "$COMMIT_COUNT" -eq "0" ]; then
            echo "No new commits found in the past week"
          else
            echo "Found $COMMIT_COUNT commits"
          fi

      - name: Construct prompt
        if: steps.fetch-commits.outputs.commit_count != '0'
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commits = JSON.parse(fs.readFileSync('/tmp/commits.json', 'utf8'));

            let commitText = '';
            for (const commit of commits) {
              commitText += `- ${commit.message} (${commit.repo})\n`;
              commitText += `  URL: ${commit.url}\n`;
            }

            const prompt = `Analyze the following Git commits and create a weekly changelog summary.

            Rules:
            - Generate MAX 5-7 bullet points total
            - If there are more commits, consolidate related changes into single bullets
            - Use concise, user-friendly language (no commit hashes or technical jargon)
            - Group related changes by theme (e.g., 'bug fixes', 'new features', 'docs')
            - Each bullet should describe the user-facing impact or purpose

            Return ONLY a valid JSON array with this exact format:
            [
              {"summary": "Description of change", "repo": "org/repo", "url": "https://..."}
            ]

            DO NOT EMIT ANY ADDITIONAL TEXT OR EXPLANATION.

            Commits to analyze:
            ${commitText}`;

            core.setOutput('prompt', prompt);

      - name: Generate changelog with Warp Agent
        if: steps.fetch-commits.outputs.commit_count != '0'
        uses: warpdotdev/oz-agent-action@f455ed6dfee334c0fa673adaeb0c8166ebef6509
        id: agent
        with:
          prompt: ${{ steps.prompt.outputs.prompt }}
          warp_api_key: ${{ secrets.WARP_API_KEY }}
          share: |
            safia@safia.rocks

      - name: Process agent output
        if: steps.fetch-commits.outputs.commit_count != '0'
        run: |
          WEEK_OF=$(date -d 'last monday' +%Y-%m-%d)
          RESPONSE='${{ steps.agent.outputs.agent_output }}'

          echo "=== Raw agent output ==="
          echo "$RESPONSE"
          echo "========================"

          # Extract JSON from code block (```json ... ```)
          # Note: JSON may start on same line as ```json marker
          ENTRIES=$(echo "$RESPONSE" | sed -n '/^```json/,/^```$/p' | sed '1s/^```json//; $d')

          echo "=== Extracted entries ==="
          echo "$ENTRIES"
          echo "========================="

          # If extraction failed or is empty, default to empty array
          if [ -z "$ENTRIES" ]; then
            echo "No JSON code block found, using empty array"
            ENTRIES="[]"
          fi

          # Validate JSON
          if ! echo "$ENTRIES" | jq . > /dev/null 2>&1; then
            echo "Invalid JSON response from Warp, using empty array"
            ENTRIES="[]"
          fi

          # Create new week entry
          NEW_WEEK=$(jq -n --arg weekOf "$WEEK_OF" --argjson entries "$ENTRIES" \
            '{weekOf: $weekOf, entries: $entries}')

          # Save for merge step
          echo "$NEW_WEEK" > /tmp/new_week.json

      - name: Merge into changelog
        if: steps.fetch-commits.outputs.commit_count != '0'
        run: |
          NEW_WEEK=$(cat /tmp/new_week.json)
          WEEK_OF=$(echo "$NEW_WEEK" | jq -r '.weekOf')

          # Check if entries array is empty
          ENTRY_COUNT=$(echo "$NEW_WEEK" | jq '.entries | length')
          if [ "$ENTRY_COUNT" -eq "0" ]; then
            echo "No entries generated, skipping update"
            exit 0
          fi

          # Read existing changelog
          CHANGELOG=$(cat data/changelog.json)

          # Check if this week already exists
          EXISTING=$(echo "$CHANGELOG" | jq --arg week "$WEEK_OF" '.weeks[] | select(.weekOf == $week)')

          if [ -n "$EXISTING" ]; then
            # Update existing week by merging entries
            UPDATED=$(echo "$CHANGELOG" | jq --arg week "$WEEK_OF" --argjson newWeek "$NEW_WEEK" '
              .weeks |= map(if .weekOf == $week then .entries += $newWeek.entries else . end)
            ')
          else
            # Add new week at the beginning
            UPDATED=$(echo "$CHANGELOG" | jq --argjson newWeek "$NEW_WEEK" '.weeks = [$newWeek] + .weeks')
          fi

          # Write back
          echo "$UPDATED" | jq '.' > data/changelog.json

      - name: Commit and push changes
        if: steps.fetch-commits.outputs.commit_count != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/changelog.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update changelog for week of $(date -d 'last monday' +%Y-%m-%d)"
            git push
          fi
